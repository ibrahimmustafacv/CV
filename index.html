<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد السيرة الذاتية - إنشاء سيرة ذاتية احترافية</title>
    
    <!-- Google Fonts for Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
/* Root Variables */
:root {
    --primary-color: #2563eb;
    --secondary-color: #64748b;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --background-color: #f8fafc;
    --surface-color: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #64748b;
    --border-color: #e2e8f0;
    --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.1);
    --shadow-heavy: 0 10px 15px rgba(0, 0, 0, 0.1);
    --border-radius: 8px;
    --transition: all 0.3s ease;
}

/* Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: var(--text-primary);
    background-color: var(--background-color);
    direction: rtl;
    text-align: right;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--primary-color), #3b82f6);
    color: white;
    padding: 20px 0;
    text-align: center;
    box-shadow: var(--shadow-medium);
}

.header-top {
    margin-bottom: 20px;
}

.header-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

.btn-header {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    text-decoration: none;
    border-radius: var(--border-radius);
    font-weight: 600;
    transition: var(--transition);
    font-size: 14px;
}

.btn-portfolio {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.btn-social {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.btn-header:hover {
    background-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

.animated-icon {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.header h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    font-weight: 700;
}

.header p {
    font-size: 1.2rem;
    opacity: 0.9;
}

/* Progress Bar */
.progress-container {
    background: var(--surface-color);
    box-shadow: var(--shadow-light);
    padding: 30px 0;
    margin-bottom: 30px;
}

.progress-bar {
    width: 100%;
    height: 6px;
    background-color: var(--border-color);
    border-radius: 3px;
    margin-bottom: 30px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-color), #3b82f6);
    border-radius: 3px;
    transition: width 0.5s ease;
    width: 0%;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    flex: 1;
    max-width: 120px;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--border-color);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    margin-bottom: 8px;
    transition: var(--transition);
    border: 3px solid transparent;
}

.step-label {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
}

.step.active .step-number {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.step.active .step-label {
    color: var(--primary-color);
    font-weight: 600;
}

.step.completed .step-number {
    background-color: var(--success-color);
    color: white;
    border-color: var(--success-color);
}

.step.completed .step-number::before {
    content: '✓';
    font-size: 14px;
}

.step.completed .step-label {
    color: var(--success-color);
}

/* Form Styles */
.form-container {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
    overflow: hidden;
    margin-bottom: 30px;
}

.form-step {
    display: none;
    padding: 40px 0;
    min-height: 500px;
}

.form-step.active {
    display: block;
}

.form-step h2 {
    font-size: 2rem;
    color: var(--text-primary);
    margin-bottom: 30px;
    text-align: center;
    font-weight: 700;
}

.form-step h2 i {
    color: var(--primary-color);
    margin-left: 10px;
}

.form-step h3 {
    color: var(--text-primary);
    margin-bottom: 20px;
    font-weight: 600;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 14px;
}

.form-group input,
.form-group textarea,
.form-group select {
    padding: 12px 16px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    font-size: 16px;
    font-family: inherit;
    transition: var(--transition);
    background-color: var(--surface-color);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-group input.error,
.form-group textarea.error,
.form-group select.error {
    border-color: var(--danger-color);
}

.field-error {
    color: var(--danger-color);
    font-size: 12px;
    margin-top: 5px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    font-weight: 500;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
}

/* Photo Upload Section */
.photo-upload-section {
    text-align: center;
    margin-bottom: 30px;
}

.photo-preview {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    border: 3px dashed var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    cursor: pointer;
    transition: var(--transition);
    background-color: #f8fafc;
    overflow: hidden;
}

.photo-preview:hover {
    border-color: var(--primary-color);
    background-color: rgba(37, 99, 235, 0.05);
}

.photo-preview i {
    font-size: 30px;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.photo-preview span {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
}

.photo-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

/* Dynamic Sections */
.dynamic-section {
    margin-bottom: 30px;
}

.experience-item,
.education-item,
.certification-item,
.skill-item,
.language-item {
    background-color: #f8fafc;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 20px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.section-header h3,
.section-header h4 {
    color: var(--text-primary);
    font-weight: 600;
}

.btn-remove {
    background-color: var(--danger-color);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 14px;
    transition: var(--transition);
}

.btn-remove:hover {
    background-color: #dc2626;
    transform: translateY(-1px);
}

.btn-add {
    display: flex;
    align-items: center;
    gap: 8px;
    background-color: var(--success-color);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: var(--transition);
    margin: 0 auto;
}

.btn-add:hover {
    background-color: #059669;
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

/* Template Selector */
.template-selector {
    margin-bottom: 30px;
}

.template-selector h3 {
    text-align: center;
    margin-bottom: 20px;
    color: var(--text-primary);
    font-weight: 600;
}

.template-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.template-option {
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    background-color: var(--surface-color);
    min-width: 120px;
}

.template-option:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-medium);
}

.template-option.active {
    border-color: var(--primary-color);
    background-color: rgba(37, 99, 235, 0.05);
}

.template-preview {
    font-size: 30px;
    color: var(--primary-color);
    margin-bottom: 10px;
}

.template-option span {
    font-weight: 600;
    color: var(--text-primary);
}

/* Preview Actions */
.preview-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

/* Buttons */
.btn-primary,
.btn-secondary,
.btn-success {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border: none;
    border-radius: var(--border-radius);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    text-align: center;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background-color: #1d4ed8;
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
}

.btn-secondary:hover {
    background-color: #475569;
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.btn-success {
    background-color: var(--success-color);
    color: white;
}

.btn-success:hover {
    background-color: #059669;
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

/* Navigation */
.form-navigation {
    display: flex;
    justify-content: space-between;
    padding: 20px;
    background: var(--surface-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-light);
    margin-bottom: 30px;
}

/* CV Preview Container */
.cv-preview-container {
    background: var(--surface-color);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-heavy);
    padding: 30px;
    margin-top: 30px;
    border: 1px solid var(--border-color);
}

.cv-preview {
    background: #ffffff;
    min-height: 400px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
    position: relative;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.loading-spinner {
    background: var(--surface-color);
    padding: 40px;
    border-radius: var(--border-radius);
    text-align: center;
    box-shadow: var(--shadow-heavy);
}

.loading-spinner i {
    font-size: 40px;
    color: var(--primary-color);
    margin-bottom: 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-spinner p {
    font-size: 16px;
    color: var(--text-primary);
    font-weight: 600;
}

/* Success Message */
.success-message {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success-color);
    color: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-heavy);
    z-index: 9999;
    animation: slideIn 0.3s ease;
}

.success-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.success-content i {
    font-size: 20px;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* CV Template Styles */
.cv-template {
    font-family: 'Cairo', sans-serif;
    line-height: 1.6;
    color: #333;
    background: #ffffff;
    max-width: 210mm;
    margin: 0 auto;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    direction: rtl;
    text-align: right;
}

/* Modern Template */
.modern-template {
    border: none;
}

.modern-template .cv-header {
    background: linear-gradient(135deg, #2563eb, #3b82f6);
    color: white;
    padding: 40px 30px;
    position: relative;
}

.modern-template .header-content {
    display: flex;
    align-items: center;
    gap: 30px;
    flex-wrap: wrap;
}

.modern-template .profile-section {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 1;
}

.modern-template .profile-photo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.3);
    object-fit: cover;
    flex-shrink: 0;
}

.modern-template .profile-photo-placeholder {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    border: 4px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    color: rgba(255, 255, 255, 0.7);
    flex-shrink: 0;
}

.modern-template .profile-info h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 5px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.modern-template .profile-info h2 {
    font-size: 1.3rem;
    font-weight: 400;
    opacity: 0.9;
    margin-bottom: 0;
}

.modern-template .contact-info {
    flex-shrink: 0;
    min-width: 250px;
}

.modern-template .contact-info div {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    font-size: 14px;
}

.modern-template .contact-info i {
    width: 16px;
    text-align: center;
    opacity: 0.8;
}

.modern-template .cv-main {
    padding: 40px 30px;
}

.modern-template .cv-section {
    margin-bottom: 35px;
}

.modern-template .cv-section:last-child {
    margin-bottom: 0;
}

.modern-template .cv-section h3 {
    font-size: 1.5rem;
    color: #2563eb;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e5e7eb;
    position: relative;
}

.modern-template .cv-section h3::after {
    content: '';
    position: absolute;
    bottom: -2px;
    right: 0;
    width: 50px;
    height: 2px;
    background: #2563eb;
}

.modern-template .experience-item,
.modern-template .education-item,
.modern-template .certification-item {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f3f4f6;
}

.modern-template .experience-item:last-child,
.modern-template .education-item:last-child,
.modern-template .certification-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.modern-template .item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.modern-template .item-header h4 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 2px;
}

.modern-template .company,
.modern-template .institution {
    color: #6b7280;
    font-weight: 500;
    font-size: 1rem;
}

.modern-template .item-date {
    color: #9ca3af;
    font-size: 14px;
    font-weight: 500;
    background: #f3f4f6;
    padding: 4px 12px;
    border-radius: 20px;
    white-space: nowrap;
}

.modern-template .item-description {
    color: #4b5563;
    margin-top: 10px;
    line-height: 1.7;
}

.modern-template .gpa {
    color: #059669;
    font-weight: 600;
    font-size: 14px;
    margin-top: 5px;
}

.modern-template .skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.modern-template .skill-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #f8fafc;
    border-radius: 8px;
    border-right: 4px solid #2563eb;
}

.modern-template .skill-name {
    font-weight: 600;
    color: #1f2937;
}

.modern-template .skill-level {
    font-size: 12px;
    color: #6b7280;
    background: #e5e7eb;
    padding: 2px 8px;
    border-radius: 12px;
}

.modern-template .languages-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
}

.modern-template .language-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 14px;
    background: #fef3c7;
    border-radius: 6px;
    border-right: 3px solid #f59e0b;
}

.modern-template .language-name {
    font-weight: 600;
    color: #92400e;
}

.modern-template .language-level {
    font-size: 12px;
    color: #a16207;
    background: rgba(245, 158, 11, 0.2);
    padding: 2px 6px;
    border-radius: 8px;
}

.modern-template .cert-url a {
    color: #2563eb;
    text-decoration: none;
    font-size: 14px;
}

.modern-template .cert-url a:hover {
    text-decoration: underline;
}

/* Classic Template */
.classic-template {
    border: 1px solid #e5e7eb;
}

.classic-template .cv-header {
    background: #f9fafb;
    border-bottom: 2px solid #d1d5db;
    padding: 30px;
    text-align: center;
}

.classic-template .header-content {
    display: block;
}

.classic-template .profile-section {
    justify-content: center;
    margin-bottom: 20px;
}

.classic-template .profile-photo {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid #6b7280;
    object-fit: cover;
    margin: 0 auto 15px;
    display: block;
}

.classic-template .profile-photo-placeholder {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 3px solid #6b7280;
    background: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    color: #6b7280;
    margin: 0 auto 15px;
}

.classic-template .profile-info h1 {
    font-size: 2.2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 5px;
}

.classic-template .profile-info h2 {
    font-size: 1.2rem;
    color: #6b7280;
    font-weight: 500;
}

.classic-template .contact-info {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 15px;
}

.classic-template .contact-info div {
    font-size: 14px;
    color: #4b5563;
}

.classic-template .cv-section h3 {
    font-size: 1.4rem;
    color: #1f2937;
    font-weight: 700;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 2px solid #1f2937;
    padding-bottom: 5px;
}

/* Creative Template */
.creative-template {
    position: relative;
    overflow: hidden;
}

.creative-template::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 6px;
    height: 100%;
    background: linear-gradient(to bottom, #2563eb, #3b82f6, #10b981, #f59e0b);
}

.creative-template .cv-header {
    background: linear-gradient(135deg, #1f2937, #374151);
    color: white;
    padding: 35px 30px 35px 40px;
    position: relative;
}

.creative-template .header-content {
    display: flex;
    align-items: center;
    gap: 25px;
}

.creative-template .profile-photo {
    width: 110px;
    height: 110px;
    border-radius: 20px;
    border: 3px solid #10b981;
    object-fit: cover;
    flex-shrink: 0;
    filter: brightness(1.1) contrast(1.1);
}

.creative-template .profile-photo-placeholder {
    width: 110px;
    height: 110px;
    border-radius: 20px;
    border: 3px solid #10b981;
    background: rgba(16, 185, 129, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 35px;
    color: #10b981;
    flex-shrink: 0;
}

.creative-template .profile-info h1 {
    font-size: 2.3rem;
    font-weight: 800;
    margin-bottom: 5px;
    background: linear-gradient(45deg, #10b981, #3b82f6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.creative-template .profile-info h2 {
    font-size: 1.2rem;
    color: #d1d5db;
    font-weight: 500;
}

.creative-template .contact-info {
    flex-shrink: 0;
}

.creative-template .contact-info div {
    margin-bottom: 6px;
    font-size: 13px;
    color: #e5e7eb;
}

.creative-template .cv-main {
    padding: 35px 30px 35px 40px;
}

.creative-template .cv-section h3 {
    font-size: 1.4rem;
    color: #1f2937;
    font-weight: 700;
    margin-bottom: 20px;
    position: relative;
    padding-right: 20px;
}

.creative-template .cv-section h3::before {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 12px;
    height: 12px;
    background: linear-gradient(45deg, #2563eb, #10b981);
    border-radius: 50%;
}

.creative-template .skill-item {
    background: linear-gradient(135deg, #f0f9ff, #ecfdf5);
    border-right: 4px solid;
    border-image: linear-gradient(45deg, #2563eb, #10b981) 1;
}

.creative-template .language-item {
    background: linear-gradient(135deg, #fef3c7, #fed7d7);
    border-right: 4px solid;
    border-image: linear-gradient(45deg, #f59e0b, #ef4444) 1;
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: 0 15px;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .progress-steps {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .step {
        max-width: 80px;
    }
    
    .step-label {
        font-size: 10px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .form-step {
        padding: 20px 0;
    }
    
    .template-options {
        justify-content: center;
    }
    
    .template-option {
        min-width: 100px;
        padding: 15px;
    }
    
    .preview-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .form-navigation {
        flex-direction: column;
        gap: 15px;
    }
    
    .header-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .modern-template .header-content,
    .creative-template .header-content {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }
    
    .modern-template .profile-section,
    .creative-template .profile-section {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    
    .modern-template .contact-info,
    .creative-template .contact-info {
        min-width: auto;
        text-align: center;
    }
    
    .modern-template .item-header,
    .classic-template .item-header,
    .creative-template .item-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .modern-template .skills-grid,
    .creative-template .skills-grid {
        grid-template-columns: 1fr;
    }
    
    .modern-template .languages-list,
    .creative-template .languages-list {
        grid-template-columns: 1fr;
    }
    
    .classic-template .contact-info {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .photo-preview {
        width: 120px;
        height: 120px;
    }
    
    .btn-header,
    .btn-primary,
    .btn-secondary,
    .btn-success {
        width: 100%;
        justify-content: center;
    }
    
    .cv-preview-container {
        padding: 15px;
    }
}

/* Print Styles */
@media print {
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    
    @page {
        size: A4;
        margin: 0.5cm;
    }
    
    body {
        font-size: 12pt;
        line-height: 1.4;
        color: #000;
        background: #fff;
    }
    
    .header,
    .progress-container,
    .form-container,
    .form-navigation,
    .preview-actions,
    .loading-overlay,
    .success-message,
    .template-selector {
        display: none !important;
    }
    
    .cv-preview-container {
        background: transparent;
        box-shadow: none;
        border: none;
        padding: 0;
        margin: 0;
    }
    
    .cv-preview {
        box-shadow: none;
        border-radius: 0;
        margin: 0;
        padding: 0;
        background: #fff;
    }
    
    .cv-template {
        box-shadow: none;
        max-width: none;
        width: 100%;
        margin: 0;
        padding: 0;
        background: #fff;
    }
    
    .modern-template .cv-header,
    .creative-template .cv-header {
        break-inside: avoid;
    }
    
    .cv-section {
        break-inside: avoid;
        page-break-inside: avoid;
    }
    
    .experience-item,
    .education-item,
    .certification-item {
        break-inside: avoid;
        page-break-inside: avoid;
    }
    
    .modern-template .profile-info h1,
    .classic-template .profile-info h1,
    .creative-template .profile-info h1 {
        font-size: 20pt;
    }
    
    .modern-template .profile-info h2,
    .classic-template .profile-info h2,
    .creative-template .profile-info h2 {
        font-size: 14pt;
    }
    
    .cv-section h3 {
        font-size: 16pt;
    }
    
    .item-header h4 {
        font-size: 13pt;
    }
    
    .profile-photo,
    .profile-photo-placeholder {
        print-color-adjust: exact;
    }
    
    .modern-template .cv-main,
    .classic-template .cv-main,
    .creative-template .cv-main {
        padding: 15pt;
    }
    
    .modern-template .cv-header,
    .classic-template .cv-header,
    .creative-template .cv-header {
        padding: 20pt 15pt;
    }
    
    .cv-section {
        margin-bottom: 15pt;
    }
    
    .experience-item,
    .education-item,
    .certification-item {
        margin-bottom: 12pt;
    }
    
    .item-description {
        orphans: 2;
        widows: 2;
    }
    
    .skill-item,
    .language-item {
        background: transparent !important;
        border: 1pt solid #ccc !important;
        border-right: 3pt solid #333 !important;
    }
    
    .contact-info div {
        margin-bottom: 3pt;
    }
}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-top">
                <div class="header-buttons">
                    <a href="https://ibrahimmustafacv.github.io/" target="_blank" class="btn-header btn-portfolio">
                        <i class="fas fa-rocket animated-icon"></i>
                        المشاريع
                    </a>
                    <a href="https://ibrahimmustafacv.github.io/my-social-media-page/" target="_blank" class="btn-header btn-social">
                        <i class="fas fa-share-alt animated-icon"></i>
                        تابعنا
                    </a>
                </div>
            </div>
            <h1><i class="fas fa-file-alt"></i> مولد السيرة الذاتية</h1>
            <p>إنشاء سيرة ذاتية احترافية في دقائق</p>
        </div>
    </header>

    <!-- Main Application -->
    <main class="main-content">
        <!-- Progress Bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <span class="step-number">1</span>
                    <span class="step-label">المعلومات الشخصية</span>
                </div>
                <div class="step" data-step="2">
                    <span class="step-number">2</span>
                    <span class="step-label">الهدف الوظيفي</span>
                </div>
                <div class="step" data-step="3">
                    <span class="step-number">3</span>
                    <span class="step-label">الخبرات</span>
                </div>
                <div class="step" data-step="4">
                    <span class="step-number">4</span>
                    <span class="step-label">التعليم</span>
                </div>
                <div class="step" data-step="5">
                    <span class="step-number">5</span>
                    <span class="step-label">المهارات</span>
                </div>
                <div class="step" data-step="6">
                    <span class="step-number">6</span>
                    <span class="step-label">المعاينة</span>
                </div>
            </div>
        </div>

        <!-- Form Container -->
        <div class="form-container" id="formContainer">
            <!-- Step 1: Personal Information -->
            <div class="form-step active" id="step1">
                <div class="container">
                    <h2><i class="fas fa-user"></i> المعلومات الشخصية</h2>
                    
                    <div class="photo-upload-section">
                        <div class="photo-preview" id="photoPreview">
                            <i class="fas fa-camera"></i>
                            <span>اضغط لإضافة صورة</span>
                        </div>
                        <input type="file" id="profilePhoto" accept="image/*" style="display: none;">
                        <button type="button" class="btn-secondary" onclick="document.getElementById('profilePhoto').click();">
                            <i class="fas fa-upload"></i> رفع صورة شخصية
                        </button>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName">الاسم الكامل *</label>
                            <input type="text" id="fullName" required>
                        </div>

                        <div class="form-group">
                            <label for="email">البريد الإلكتروني *</label>
                            <input type="email" id="email" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">رقم الهاتف *</label>
                            <input type="tel" id="phone" required>
                        </div>

                        <div class="form-group">
                            <label for="address">العنوان</label>
                            <input type="text" id="address">
                        </div>

                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="url" id="linkedin" placeholder="https://linkedin.com/in/username">
                        </div>

                        <div class="form-group">
                            <label for="github">GitHub</label>
                            <input type="url" id="github" placeholder="https://github.com/username">
                        </div>

                        <div class="form-group">
                            <label for="website">موقع شخصي</label>
                            <input type="url" id="website" placeholder="https://your-website.com">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Career Objective -->
            <div class="form-step" id="step2">
                <div class="container">
                    <h2><i class="fas fa-bullseye"></i> الهدف الوظيفي والملخص الشخصي</h2>
                    
                    <div class="form-group">
                        <label for="jobTitle">المسمى الوظيفي المطلوب *</label>
                        <input type="text" id="jobTitle" required placeholder="مثال: مطور ويب، مصمم جرافيك، محاسب">
                    </div>

                    <div class="form-group">
                        <label for="careerObjective">هدفك المهني *</label>
                        <textarea id="careerObjective" rows="4" required placeholder="اكتب هدفك المهني وطموحاتك الوظيفية..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="personalSummary">الملخص الشخصي *</label>
                        <textarea id="personalSummary" rows="5" required placeholder="اكتب ملخصاً عن خبراتك ومهاراتك وما يميزك..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Step 3: Work Experience -->
            <div class="form-step" id="step3">
                <div class="container">
                    <h2><i class="fas fa-briefcase"></i> الخبرات العملية والمشاريع</h2>
                    
                    <div class="dynamic-section" id="experienceSection">
                        <div class="experience-item" data-index="0">
                            <div class="section-header">
                                <h3>الخبرة الأولى</h3>
                                <button type="button" class="btn-remove" onclick="removeExperience(0)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>المسمى الوظيفي</label>
                                    <input type="text" name="experience[0][position]">
                                </div>
                                
                                <div class="form-group">
                                    <label>اسم الشركة/المؤسسة</label>
                                    <input type="text" name="experience[0][company]">
                                </div>
                                
                                <div class="form-group">
                                    <label>تاريخ البداية</label>
                                    <input type="month" name="experience[0][startDate]">
                                </div>
                                
                                <div class="form-group">
                                    <label>تاريخ النهاية</label>
                                    <input type="month" name="experience[0][endDate]">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="experience[0][current]">
                                        <span>أعمل حالياً</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>وصف المهام والإنجازات</label>
                                <textarea name="experience[0][description]" rows="4" placeholder="اكتب وصفاً مفصلاً عن مهامك وإنجازاتك..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add" onclick="addExperience()">
                        <i class="fas fa-plus"></i> إضافة خبرة أخرى
                    </button>
                </div>
            </div>

            <!-- Step 4: Education -->
            <div class="form-step" id="step4">
                <div class="container">
                    <h2><i class="fas fa-graduation-cap"></i> المؤهلات التعليمية والشهادات</h2>
                    
                    <!-- Education Section -->
                    <h3>التعليم</h3>
                    <div class="dynamic-section" id="educationSection">
                        <div class="education-item" data-index="0">
                            <div class="section-header">
                                <h4>المؤهل الأول</h4>
                                <button type="button" class="btn-remove" onclick="removeEducation(0)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>الدرجة العلمية</label>
                                    <select name="education[0][degree]">
                                        <option value="">اختر الدرجة</option>
                                        <option value="دبلوم">دبلوم</option>
                                        <option value="بكالوريوس">بكالوريوس</option>
                                        <option value="ماجستير">ماجستير</option>
                                        <option value="دكتوراه">دكتوراه</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>التخصص</label>
                                    <input type="text" name="education[0][major]">
                                </div>
                                
                                <div class="form-group">
                                    <label>اسم الجامعة/المؤسسة</label>
                                    <input type="text" name="education[0][institution]">
                                </div>
                                
                                <div class="form-group">
                                    <label>سنة التخرج</label>
                                    <input type="number" name="education[0][year]" min="1950" max="2030">
                                </div>
                                
                                <div class="form-group">
                                    <label>المعدل (اختياري)</label>
                                    <input type="text" name="education[0][gpa]" placeholder="3.8/4.0 أو امتياز">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add" onclick="addEducation()">
                        <i class="fas fa-plus"></i> إضافة مؤهل آخر
                    </button>

                    <!-- Certifications Section -->
                    <h3 style="margin-top: 30px;">الشهادات والدورات</h3>
                    <div class="dynamic-section" id="certificationsSection">
                        <div class="certification-item" data-index="0">
                            <div class="section-header">
                                <h4>الشهادة الأولى</h4>
                                <button type="button" class="btn-remove" onclick="removeCertification(0)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>اسم الشهادة</label>
                                    <input type="text" name="certification[0][name]">
                                </div>
                                
                                <div class="form-group">
                                    <label>الجهة المانحة</label>
                                    <input type="text" name="certification[0][issuer]">
                                </div>
                                
                                <div class="form-group">
                                    <label>تاريخ الحصول</label>
                                    <input type="month" name="certification[0][date]">
                                </div>
                                
                                <div class="form-group">
                                    <label>رابط التحقق (اختياري)</label>
                                    <input type="url" name="certification[0][url]" placeholder="https://...">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add" onclick="addCertification()">
                        <i class="fas fa-plus"></i> إضافة شهادة أخرى
                    </button>
                </div>
            </div>

            <!-- Step 5: Skills -->
            <div class="form-step" id="step5">
                <div class="container">
                    <h2><i class="fas fa-cogs"></i> المهارات واللغات</h2>
                    
                    <!-- Technical Skills -->
                    <h3>المهارات التقنية</h3>
                    <div class="dynamic-section" id="technicalSkillsSection">
                        <div class="skill-item" data-index="0">
                            <div class="section-header">
                                <h4>المهارة الأولى</h4>
                                <button type="button" class="btn-remove" onclick="removeTechnicalSkill(0)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>اسم المهارة</label>
                                    <input type="text" name="technicalSkill[0][name]" placeholder="مثال: JavaScript, Photoshop, المحاسبة">
                                </div>
                                
                                <div class="form-group">
                                    <label>مستوى الإتقان</label>
                                    <select name="technicalSkill[0][level]">
                                        <option value="">اختر المستوى</option>
                                        <option value="مبتدئ">مبتدئ</option>
                                        <option value="متوسط">متوسط</option>
                                        <option value="متقدم">متقدم</option>
                                        <option value="خبير">خبير</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add" onclick="addTechnicalSkill()">
                        <i class="fas fa-plus"></i> إضافة مهارة أخرى
                    </button>

                    <!-- Soft Skills -->
                    <h3 style="margin-top: 30px;">المهارات الشخصية والاجتماعية</h3>
                    <div class="form-group">
                        <label for="softSkills">اكتب مهاراتك الشخصية</label>
                        <textarea id="softSkills" rows="4" placeholder="مثال: القيادة، العمل الجماعي، التواصل الفعال، إدارة الوقت، حل المشكلات..."></textarea>
                    </div>

                    <!-- Languages -->
                    <h3 style="margin-top: 30px;">اللغات</h3>
                    <div class="dynamic-section" id="languagesSection">
                        <div class="language-item" data-index="0">
                            <div class="section-header">
                                <h4>اللغة الأولى</h4>
                                <button type="button" class="btn-remove" onclick="removeLanguage(0)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>اللغة</label>
                                    <input type="text" name="language[0][name]" placeholder="العربية، الإنجليزية، الفرنسية...">
                                </div>
                                
                                <div class="form-group">
                                    <label>مستوى الإتقان</label>
                                    <select name="language[0][level]">
                                        <option value="">اختر المستوى</option>
                                        <option value="مبتدئ">مبتدئ</option>
                                        <option value="متوسط">متوسط</option>
                                        <option value="متقدم">متقدم</option>
                                        <option value="لغة أم">لغة أم</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-add" onclick="addLanguage()">
                        <i class="fas fa-plus"></i> إضافة لغة أخرى
                    </button>
                </div>
            </div>

            <!-- Step 6: Preview -->
            <div class="form-step" id="step6">
                <div class="container">
                    <h2><i class="fas fa-eye"></i> معاينة السيرة الذاتية</h2>
                    
                    <!-- Template Selector -->
                    <div class="template-selector">
                        <h3>اختر تصميم السيرة الذاتية</h3>
                        <div class="template-options">
                            <div class="template-option active" data-template="modern">
                                <div class="template-preview">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <span>عصري</span>
                            </div>
                            <div class="template-option" data-template="classic">
                                <div class="template-preview">
                                    <i class="fas fa-file-text"></i>
                                </div>
                                <span>كلاسيكي</span>
                            </div>
                            <div class="template-option" data-template="creative">
                                <div class="template-preview">
                                    <i class="fas fa-palette"></i>
                                </div>
                                <span>إبداعي</span>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Actions -->
                    <div class="preview-actions">
                        <button type="button" class="btn-primary" onclick="printCV()">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                        <button type="button" class="btn-success" onclick="downloadPDF()">
                            <i class="fas fa-download"></i> تحميل PDF
                        </button>
                    </div>

                    <!-- CV Preview -->
                    <div class="cv-preview-container">
                        <div class="cv-preview" id="cvPreview">
                            <!-- CV content will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="form-navigation">
            <button type="button" class="btn-secondary" id="prevBtn" onclick="changeStep(-1)" style="display: none;">
                <i class="fas fa-arrow-right"></i> السابق
            </button>
            
            <button type="button" class="btn-primary" id="nextBtn" onclick="changeStep(1)">
                التالي <i class="fas fa-arrow-left"></i>
            </button>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner"></i>
            <p>جاري إنشاء ملف PDF...</p>
        </div>
    </div>

    <script>
// Global variables
let currentStep = 1;
let totalSteps = 6;
let currentProfileImage = null;
let profileImageData = null;

// Initialize application
document.addEventListener('DOMContentLoaded', function() {
    initializeApplication();
});

function initializeApplication() {
    setupEventListeners();
    updateProgressBar();
    updateNavigation();
}

function setupEventListeners() {
    // Profile photo upload
    const profilePhotoInput = document.getElementById('profilePhoto');
    if (profilePhotoInput) {
        profilePhotoInput.addEventListener('change', handleProfilePhotoUpload);
    }

    // Template selector
    const templateOptions = document.querySelectorAll('.template-option');
    templateOptions.forEach(option => {
        option.addEventListener('click', function() {
            selectTemplate(this.dataset.template);
        });
    });

    // Form validation
    setupFormValidation();
}

function handleProfilePhotoUpload(event) {
    const file = event.target.files[0];
    if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert('يرجى اختيار ملف صورة صحيح');
            return;
        }

        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('حجم الصورة كبير جداً. يرجى اختيار صورة أصغر من 5 ميجابايت');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                // Create image element to validate and process
                const img = new Image();
                img.onload = function() {
                    // Process and validate image
                    processProfileImage(img, e.target.result);
                };
                img.onerror = function() {
                    alert('فشل في تحميل الصورة. يرجى المحاولة مرة أخرى');
                };
                img.src = e.target.result;
            } catch (error) {
                console.error('Error processing image:', error);
                alert('حدث خطأ في معالجة الصورة');
            }
        };
        reader.onerror = function() {
            alert('فشل في قراءة الصورة');
        };
        reader.readAsDataURL(file);
    }
}

function processProfileImage(img, dataUrl) {
    try {
        // Create canvas to process image
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size (max 300x300 for optimization)
        const maxSize = 300;
        let { width, height } = img;
        
        if (width > height) {
            if (width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
            }
        } else {
            if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
            }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Clear canvas with white background
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, width, height);
        
        // Draw image
        ctx.drawImage(img, 0, 0, width, height);
        
        // Get processed image data
        const processedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
        
        // Validate the processed image data
        if (processedDataUrl && processedDataUrl.length > 0) {
            profileImageData = processedDataUrl;
            
            // Update preview
            const photoPreview = document.getElementById('photoPreview');
            photoPreview.innerHTML = `<img src="${processedDataUrl}" alt="صورة شخصية" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
            
            console.log('Profile image processed successfully');
        } else {
            throw new Error('Failed to process image data');
        }
    } catch (error) {
        console.error('Error in processProfileImage:', error);
        alert('حدث خطأ في معالجة الصورة. يرجى المحاولة مرة أخرى');
        profileImageData = null;
    }
}

function setupFormValidation() {
    const requiredFields = document.querySelectorAll('input[required], textarea[required]');
    requiredFields.forEach(field => {
        field.addEventListener('blur', validateField);
        field.addEventListener('input', clearFieldError);
    });
}

function validateField(event) {
    const field = event.target;
    const value = field.value.trim();
    
    if (!value) {
        showFieldError(field, 'هذا الحقل مطلوب');
        return false;
    }
    
    // Email validation
    if (field.type === 'email' && value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
            showFieldError(field, 'يرجى إدخال بريد إلكتروني صحيح');
            return false;
        }
    }
    
    clearFieldError(field);
    return true;
}

function showFieldError(field, message) {
    clearFieldError(field);
    field.classList.add('error');
    
    const errorElement = document.createElement('span');
    errorElement.className = 'field-error';
    errorElement.textContent = message;
    field.parentNode.appendChild(errorElement);
}

function clearFieldError(field) {
    field.classList.remove('error');
    const errorElement = field.parentNode.querySelector('.field-error');
    if (errorElement) {
        errorElement.remove();
    }
}

function changeStep(direction) {
    const newStep = currentStep + direction;
    
    if (newStep < 1 || newStep > totalSteps) {
        return;
    }
    
    if (direction > 0 && !validateCurrentStep()) {
        return;
    }
    
    // Hide current step
    document.getElementById(`step${currentStep}`).classList.remove('active');
    
    // Show new step
    currentStep = newStep;
    document.getElementById(`step${currentStep}`).classList.add('active');
    
    // Update progress and navigation
    updateProgressBar();
    updateNavigation();
    
    // Generate preview if on last step
    if (currentStep === totalSteps) {
        generatePreview();
    }
}

function validateCurrentStep() {
    const currentStepElement = document.getElementById(`step${currentStep}`);
    const requiredFields = currentStepElement.querySelectorAll('input[required], textarea[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!validateField({ target: field })) {
            isValid = false;
        }
    });
    
    if (!isValid) {
        alert('يرجى تعبئة جميع الحقول المطلوبة');
    }
    
    return isValid;
}

function updateProgressBar() {
    const progressFill = document.getElementById('progressFill');
    const steps = document.querySelectorAll('.step');
    
    // Update progress bar width
    const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    progressFill.style.width = `${progressPercentage}%`;
    
    // Update step indicators
    steps.forEach((step, index) => {
        const stepNumber = index + 1;
        if (stepNumber < currentStep) {
            step.classList.add('completed');
            step.classList.remove('active');
        } else if (stepNumber === currentStep) {
            step.classList.add('active');
            step.classList.remove('completed');
        } else {
            step.classList.remove('active', 'completed');
        }
    });
}

function updateNavigation() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Show/hide previous button
    prevBtn.style.display = currentStep > 1 ? 'inline-block' : 'none';
    
    // Update next button text
    if (currentStep === totalSteps) {
        nextBtn.style.display = 'none';
    } else {
        nextBtn.style.display = 'inline-block';
        nextBtn.innerHTML = currentStep === totalSteps - 1 ? 
            'معاينة <i class="fas fa-eye"></i>' : 
            'التالي <i class="fas fa-arrow-left"></i>';
    }
}

function selectTemplate(templateName) {
    document.querySelectorAll('.template-option').forEach(option => {
        option.classList.remove('active');
    });
    
    document.querySelector(`[data-template="${templateName}"]`).classList.add('active');
    
    // Regenerate preview with new template
    if (currentStep === totalSteps) {
        generatePreview();
    }
}

// Dynamic form functions
function addExperience() {
    const section = document.getElementById('experienceSection');
    const index = section.children.length;
    
    const newItem = createExperienceItem(index);
    section.appendChild(newItem);
}

function removeExperience(index) {
    const item = document.querySelector(`[data-index="${index}"].experience-item`);
    if (item && document.querySelectorAll('.experience-item').length > 1) {
        item.remove();
    }
}

function createExperienceItem(index) {
    const div = document.createElement('div');
    div.className = 'experience-item';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="section-header">
            <h3>الخبرة ${index + 1}</h3>
            <button type="button" class="btn-remove" onclick="removeExperience(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>المسمى الوظيفي</label>
                <input type="text" name="experience[${index}][position]">
            </div>
            
            <div class="form-group">
                <label>اسم الشركة/المؤسسة</label>
                <input type="text" name="experience[${index}][company]">
            </div>
            
            <div class="form-group">
                <label>تاريخ البداية</label>
                <input type="month" name="experience[${index}][startDate]">
            </div>
            
            <div class="form-group">
                <label>تاريخ النهاية</label>
                <input type="month" name="experience[${index}][endDate]">
                <label class="checkbox-label">
                    <input type="checkbox" name="experience[${index}][current]">
                    <span>أعمل حالياً</span>
                </label>
            </div>
        </div>
        
        <div class="form-group">
            <label>وصف المهام والإنجازات</label>
            <textarea name="experience[${index}][description]" rows="4" placeholder="اكتب وصفاً مفصلاً عن مهامك وإنجازاتك..."></textarea>
        </div>
    `;
    
    return div;
}

function addEducation() {
    const section = document.getElementById('educationSection');
    const index = section.children.length;
    const newItem = createEducationItem(index);
    section.appendChild(newItem);
}

function removeEducation(index) {
    const item = document.querySelector(`[data-index="${index}"].education-item`);
    if (item && document.querySelectorAll('.education-item').length > 1) {
        item.remove();
    }
}

function createEducationItem(index) {
    const div = document.createElement('div');
    div.className = 'education-item';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="section-header">
            <h4>المؤهل ${index + 1}</h4>
            <button type="button" class="btn-remove" onclick="removeEducation(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>الدرجة العلمية</label>
                <select name="education[${index}][degree]">
                    <option value="">اختر الدرجة</option>
                    <option value="دبلوم">دبلوم</option>
                    <option value="بكالوريوس">بكالوريوس</option>
                    <option value="ماجستير">ماجستير</option>
                    <option value="دكتوراه">دكتوراه</option>
                    <option value="أخرى">أخرى</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>التخصص</label>
                <input type="text" name="education[${index}][major]">
            </div>
            
            <div class="form-group">
                <label>اسم الجامعة/المؤسسة</label>
                <input type="text" name="education[${index}][institution]">
            </div>
            
            <div class="form-group">
                <label>سنة التخرج</label>
                <input type="number" name="education[${index}][year]" min="1950" max="2030">
            </div>
            
            <div class="form-group">
                <label>المعدل (اختياري)</label>
                <input type="text" name="education[${index}][gpa]" placeholder="3.8/4.0 أو امتياز">
            </div>
        </div>
    `;
    
    return div;
}

function addCertification() {
    const section = document.getElementById('certificationsSection');
    const index = section.children.length;
    const newItem = createCertificationItem(index);
    section.appendChild(newItem);
}

function removeCertification(index) {
    const item = document.querySelector(`[data-index="${index}"].certification-item`);
    if (item && document.querySelectorAll('.certification-item').length > 1) {
        item.remove();
    }
}

function createCertificationItem(index) {
    const div = document.createElement('div');
    div.className = 'certification-item';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="section-header">
            <h4>الشهادة ${index + 1}</h4>
            <button type="button" class="btn-remove" onclick="removeCertification(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>اسم الشهادة</label>
                <input type="text" name="certification[${index}][name]">
            </div>
            
            <div class="form-group">
                <label>الجهة المانحة</label>
                <input type="text" name="certification[${index}][issuer]">
            </div>
            
            <div class="form-group">
                <label>تاريخ الحصول</label>
                <input type="month" name="certification[${index}][date]">
            </div>
            
            <div class="form-group">
                <label>رابط التحقق (اختياري)</label>
                <input type="url" name="certification[${index}][url]" placeholder="https://...">
            </div>
        </div>
    `;
    
    return div;
}

function addTechnicalSkill() {
    const section = document.getElementById('technicalSkillsSection');
    const index = section.children.length;
    const newItem = createTechnicalSkillItem(index);
    section.appendChild(newItem);
}

function removeTechnicalSkill(index) {
    const item = document.querySelector(`[data-index="${index}"].skill-item`);
    if (item && document.querySelectorAll('.skill-item').length > 1) {
        item.remove();
    }
}

function createTechnicalSkillItem(index) {
    const div = document.createElement('div');
    div.className = 'skill-item';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="section-header">
            <h4>المهارة ${index + 1}</h4>
            <button type="button" class="btn-remove" onclick="removeTechnicalSkill(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>اسم المهارة</label>
                <input type="text" name="technicalSkill[${index}][name]" placeholder="مثال: JavaScript, Photoshop, المحاسبة">
            </div>
            
            <div class="form-group">
                <label>مستوى الإتقان</label>
                <select name="technicalSkill[${index}][level]">
                    <option value="">اختر المستوى</option>
                    <option value="مبتدئ">مبتدئ</option>
                    <option value="متوسط">متوسط</option>
                    <option value="متقدم">متقدم</option>
                    <option value="خبير">خبير</option>
                </select>
            </div>
        </div>
    `;
    
    return div;
}

function addLanguage() {
    const section = document.getElementById('languagesSection');
    const index = section.children.length;
    const newItem = createLanguageItem(index);
    section.appendChild(newItem);
}

function removeLanguage(index) {
    const item = document.querySelector(`[data-index="${index}"].language-item`);
    if (item && document.querySelectorAll('.language-item').length > 1) {
        item.remove();
    }
}

function createLanguageItem(index) {
    const div = document.createElement('div');
    div.className = 'language-item';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="section-header">
            <h4>اللغة ${index + 1}</h4>
            <button type="button" class="btn-remove" onclick="removeLanguage(${index})">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="form-grid">
            <div class="form-group">
                <label>اللغة</label>
                <input type="text" name="language[${index}][name]" placeholder="العربية، الإنجليزية، الفرنسية...">
            </div>
            
            <div class="form-group">
                <label>مستوى الإتقان</label>
                <select name="language[${index}][level]">
                    <option value="">اختر المستوى</option>
                    <option value="مبتدئ">مبتدئ</option>
                    <option value="متوسط">متوسط</option>
                    <option value="متقدم">متقدم</option>
                    <option value="لغة أم">لغة أم</option>
                </select>
            </div>
        </div>
    `;
    
    return div;
}

function generatePreview() {
    try {
        const cvData = collectFormData();
        const selectedTemplate = document.querySelector('.template-option.active').dataset.template;
        const previewContainer = document.getElementById('cvPreview');
        
        // Generate preview based on selected template
        switch (selectedTemplate) {
            case 'modern':
                previewContainer.innerHTML = generateModernTemplate(cvData);
                break;
            case 'classic':
                previewContainer.innerHTML = generateClassicTemplate(cvData);
                break;
            case 'creative':
                previewContainer.innerHTML = generateCreativeTemplate(cvData);
                break;
            default:
                previewContainer.innerHTML = generateModernTemplate(cvData);
        }
        
        console.log('Preview generated successfully');
    } catch (error) {
        console.error('Error generating preview:', error);
        alert('حدث خطأ في إنشاء المعاينة');
    }
}

function collectFormData() {
    const data = {
        personalInfo: {
            fullName: document.getElementById('fullName').value.trim(),
            email: document.getElementById('email').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            address: document.getElementById('address').value.trim(),
            linkedin: document.getElementById('linkedin').value.trim(),
            github: document.getElementById('github').value.trim(),
            website: document.getElementById('website').value.trim(),
            photo: profileImageData
        },
        objective: {
            jobTitle: document.getElementById('jobTitle').value.trim(),
            careerObjective: document.getElementById('careerObjective').value.trim(),
            personalSummary: document.getElementById('personalSummary').value.trim()
        },
        experience: [],
        education: [],
        certifications: [],
        technicalSkills: [],
        softSkills: document.getElementById('softSkills').value.trim(),
        languages: []
    };
    
    // Collect experiences
    document.querySelectorAll('.experience-item').forEach((item, index) => {
        const exp = {
            position: item.querySelector(`[name="experience[${index}][position]"]`)?.value.trim() || '',
            company: item.querySelector(`[name="experience[${index}][company]"]`)?.value.trim() || '',
            startDate: item.querySelector(`[name="experience[${index}][startDate]"]`)?.value || '',
            endDate: item.querySelector(`[name="experience[${index}][endDate]"]`)?.value || '',
            current: item.querySelector(`[name="experience[${index}][current]"]`)?.checked || false,
            description: item.querySelector(`[name="experience[${index}][description]"]`)?.value.trim() || ''
        };
        if (exp.position || exp.company) {
            data.experience.push(exp);
        }
    });
    
    // Collect education
    document.querySelectorAll('.education-item').forEach((item, index) => {
        const edu = {
            degree: item.querySelector(`[name="education[${index}][degree]"]`)?.value || '',
            major: item.querySelector(`[name="education[${index}][major]"]`)?.value.trim() || '',
            institution: item.querySelector(`[name="education[${index}][institution]"]`)?.value.trim() || '',
            year: item.querySelector(`[name="education[${index}][year]"]`)?.value || '',
            gpa: item.querySelector(`[name="education[${index}][gpa]"]`)?.value.trim() || ''
        };
        if (edu.degree || edu.major || edu.institution) {
            data.education.push(edu);
        }
    });
    
    // Collect certifications
    document.querySelectorAll('.certification-item').forEach((item, index) => {
        const cert = {
            name: item.querySelector(`[name="certification[${index}][name]"]`)?.value.trim() || '',
            issuer: item.querySelector(`[name="certification[${index}][issuer]"]`)?.value.trim() || '',
            date: item.querySelector(`[name="certification[${index}][date]"]`)?.value || '',
            url: item.querySelector(`[name="certification[${index}][url]"]`)?.value.trim() || ''
        };
        if (cert.name || cert.issuer) {
            data.certifications.push(cert);
        }
    });
    
    // Collect technical skills
    document.querySelectorAll('.skill-item').forEach((item, index) => {
        const skill = {
            name: item.querySelector(`[name="technicalSkill[${index}][name]"]`)?.value.trim() || '',
            level: item.querySelector(`[name="technicalSkill[${index}][level]"]`)?.value || ''
        };
        if (skill.name) {
            data.technicalSkills.push(skill);
        }
    });
    
    // Collect languages
    document.querySelectorAll('.language-item').forEach((item, index) => {
        const lang = {
            name: item.querySelector(`[name="language[${index}][name]"]`)?.value.trim() || '',
            level: item.querySelector(`[name="language[${index}][level]"]`)?.value || ''
        };
        if (lang.name) {
            data.languages.push(lang);
        }
    });
    
    return data;
}

function printCV() {
    window.print();
}

// Template generators
function generateModernTemplate(data) {
    const photoHtml = data.personalInfo.photo ? 
        `<img src="${data.personalInfo.photo}" alt="الصورة الشخصية" class="profile-photo">` : 
        '<div class="profile-photo-placeholder"><i class="fas fa-user"></i></div>';
    
    return `
        <div class="cv-template modern-template">
            <header class="cv-header">
                <div class="header-content">
                    <div class="profile-section">
                        ${photoHtml}
                        <div class="profile-info">
                            <h1>${data.personalInfo.fullName || 'الاسم غير متوفر'}</h1>
                            <h2>${data.objective.jobTitle || 'المسمى الوظيفي'}</h2>
                        </div>
                    </div>
                    <div class="contact-info">
                        ${data.personalInfo.email ? `<div><i class="fas fa-envelope"></i> ${data.personalInfo.email}</div>` : ''}
                        ${data.personalInfo.phone ? `<div><i class="fas fa-phone"></i> ${data.personalInfo.phone}</div>` : ''}
                        ${data.personalInfo.address ? `<div><i class="fas fa-map-marker-alt"></i> ${data.personalInfo.address}</div>` : ''}
                        ${data.personalInfo.linkedin ? `<div><i class="fab fa-linkedin"></i> ${data.personalInfo.linkedin}</div>` : ''}
                        ${data.personalInfo.github ? `<div><i class="fab fa-github"></i> ${data.personalInfo.github}</div>` : ''}
                        ${data.personalInfo.website ? `<div><i class="fas fa-globe"></i> ${data.personalInfo.website}</div>` : ''}
                    </div>
                </div>
            </header>
            
            <main class="cv-main">
                ${data.objective.personalSummary ? `
                    <section class="cv-section">
                        <h3>الملخص الشخصي</h3>
                        <p>${data.objective.personalSummary}</p>
                    </section>
                ` : ''}
                
                ${data.objective.careerObjective ? `
                    <section class="cv-section">
                        <h3>الهدف المهني</h3>
                        <p>${data.objective.careerObjective}</p>
                    </section>
                ` : ''}
                
                ${data.experience.length > 0 ? `
                    <section class="cv-section">
                        <h3>الخبرات العملية</h3>
                        ${data.experience.map(exp => `
                            <div class="experience-item">
                                <div class="item-header">
                                    <div>
                                        <h4>${exp.position}</h4>
                                        <span class="company">${exp.company}</span>
                                    </div>
                                    <span class="item-date">
                                        ${formatDate(exp.startDate)} - ${exp.current ? 'حتى الآن' : formatDate(exp.endDate)}
                                    </span>
                                </div>
                                ${exp.description ? `<p class="item-description">${exp.description}</p>` : ''}
                            </div>
                        `).join('')}
                    </section>
                ` : ''}
                
                ${data.education.length > 0 ? `
                    <section class="cv-section">
                        <h3>التعليم</h3>
                        ${data.education.map(edu => `
                            <div class="education-item">
                                <div class="item-header">
                                    <div>
                                        <h4>${edu.degree} - ${edu.major}</h4>
                                        <span class="institution">${edu.institution}</span>
                                    </div>
                                    <span class="item-date">${edu.year}</span>
                                </div>
                                ${edu.gpa ? `<div class="gpa">المعدل: ${edu.gpa}</div>` : ''}
                            </div>
                        `).join('')}
                    </section>
                ` : ''}
                
                ${data.technicalSkills.length > 0 ? `
                    <section class="cv-section">
                        <h3>المهارات التقنية</h3>
                        <div class="skills-grid">
                            ${data.technicalSkills.map(skill => `
                                <div class="skill-item">
                                    <span class="skill-name">${skill.name}</span>
                                    <span class="skill-level">${skill.level}</span>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                ` : ''}
                
                ${data.softSkills ? `
                    <section class="cv-section">
                        <h3>المهارات الشخصية</h3>
                        <p>${data.softSkills}</p>
                    </section>
                ` : ''}
                
                ${data.languages.length > 0 ? `
                    <section class="cv-section">
                        <h3>اللغات</h3>
                        <div class="languages-list">
                            ${data.languages.map(lang => `
                                <div class="language-item">
                                    <span class="language-name">${lang.name}</span>
                                    <span class="language-level">${lang.level}</span>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                ` : ''}
                
                ${data.certifications.length > 0 ? `
                    <section class="cv-section">
                        <h3>الشهادات</h3>
                        ${data.certifications.map(cert => `
                            <div class="certification-item">
                                <div class="item-header">
                                    <div>
                                        <h4>${cert.name}</h4>
                                        <span class="issuer">${cert.issuer}</span>
                                    </div>
                                    <span class="item-date">${formatDate(cert.date)}</span>
                                </div>
                                ${cert.url ? `<div class="cert-url"><a href="${cert.url}" target="_blank">رابط التحقق</a></div>` : ''}
                            </div>
                        `).join('')}
                    </section>
                ` : ''}
            </main>
        </div>
    `;
}

function generateClassicTemplate(data) {
    // Similar to modern but with classic styling
    return generateModernTemplate(data).replace('modern-template', 'classic-template');
}

function generateCreativeTemplate(data) {
    // Similar to modern but with creative styling
    return generateModernTemplate(data).replace('modern-template', 'creative-template');
}

function formatDate(dateString) {
    if (!dateString) return '';
    
    const date = new Date(dateString + '-01'); // Add day for month input
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    
    const monthNames = [
        'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
        'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
    ];
    
    return `${monthNames[month - 1]} ${year}`;
}

// PDF Generation with Enhanced Image Handling
function downloadPDF() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    try {
        // Show loading overlay
        loadingOverlay.style.display = 'flex';
        
        // Pre-process images before PDF generation
        preprocessImagesForPDF().then(() => {
            generatePDFDocument();
        }).catch(error => {
            console.error('Error preprocessing images:', error);
            handlePDFError('فشل في معالجة الصور قبل إنشاء PDF');
        });
        
    } catch (error) {
        console.error('Error in downloadPDF:', error);
        handlePDFError('حدث خطأ غير متوقع');
    }
}

async function preprocessImagesForPDF() {
    return new Promise((resolve, reject) => {
        try {
            const cvPreview = document.getElementById('cvPreview');
            const images = cvPreview.querySelectorAll('img');
            
            if (images.length === 0) {
                resolve();
                return;
            }
            
            let processedCount = 0;
            const totalImages = images.length;
            
            images.forEach((img, index) => {
                processImageForPDF(img)
                    .then(() => {
                        processedCount++;
                        if (processedCount === totalImages) {
                            resolve();
                        }
                    })
                    .catch(error => {
                        console.error(`Error processing image ${index}:`, error);
                        // Continue processing other images
                        processedCount++;
                        if (processedCount === totalImages) {
                            resolve();
                        }
                    });
            });
            
        } catch (error) {
            reject(error);
        }
    });
}

function processImageForPDF(imgElement) {
    return new Promise((resolve, reject) => {
        try {
            // Skip if image is already processed or has issues
            if (!imgElement.src || imgElement.src === '') {
                resolve();
                return;
            }
            
            // Create a new image to ensure it's fully loaded
            const tempImg = new Image();
            
            tempImg.onload = function() {
                try {
                    // Create canvas for image processing
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Validate image dimensions
                    const width = this.naturalWidth || this.width;
                    const height = this.naturalHeight || this.height;
                    
                    if (!width || !height || width <= 0 || height <= 0) {
                        console.warn('Invalid image dimensions:', width, height);
                        resolve();
                        return;
                    }
                    
                    // Set canvas size with reasonable limits
                    const maxDimension = 800;
                    let canvasWidth = width;
                    let canvasHeight = height;
                    
                    if (width > maxDimension || height > maxDimension) {
                        if (width > height) {
                            canvasWidth = maxDimension;
                            canvasHeight = (height * maxDimension) / width;
                        } else {
                            canvasHeight = maxDimension;
                            canvasWidth = (width * maxDimension) / height;
                        }
                    }
                    
                    // Ensure dimensions are valid numbers
                    canvasWidth = Math.floor(Math.max(1, canvasWidth));
                    canvasHeight = Math.floor(Math.max(1, canvasHeight));
                    
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    
                    // Clear canvas with white background
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvasWidth, canvasHeight);
                    
                    // Validate context and image before drawing
                    if (ctx && this.complete) {
                        // Set smooth image rendering
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // Draw image with error handling
                        try {
                            ctx.drawImage(this, 0, 0, canvasWidth, canvasHeight);
                            
                            // Convert to data URL with error handling
                            const processedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
                            
                            if (processedDataUrl && processedDataUrl.length > 0) {
                                // Update original image source
                                imgElement.src = processedDataUrl;
                                
                                // Add attributes to help with PDF generation
                                imgElement.setAttribute('data-processed', 'true');
                                imgElement.setAttribute('data-original-width', canvasWidth);
                                imgElement.setAttribute('data-original-height', canvasHeight);
                                
                                console.log(`Image processed successfully: ${canvasWidth}x${canvasHeight}`);
                                resolve();
                            } else {
                                throw new Error('Failed to generate processed image data');
                            }
                            
                        } catch (drawError) {
                            console.error('Error drawing image to canvas:', drawError);
                            resolve(); // Continue without failing
                        }
                    } else {
                        console.warn('Invalid canvas context or incomplete image');
                        resolve();
                    }
                    
                } catch (canvasError) {
                    console.error('Error processing image with canvas:', canvasError);
                    resolve(); // Continue without failing
                }
            };
            
            tempImg.onerror = function() {
                console.error('Error loading image for processing');
                resolve(); // Continue without failing
            };
            
            // Handle cross-origin images
            tempImg.crossOrigin = 'anonymous';
            tempImg.src = imgElement.src;
            
            // Timeout fallback
            setTimeout(() => {
                if (!tempImg.complete) {
                    console.warn('Image processing timeout');
                    resolve();
                }
            }, 10000);
            
        } catch (error) {
            console.error('Error in processImageForPDF:', error);
            resolve(); // Continue without failing
        }
    });
}

function generatePDFDocument() {
    try {
        const cvPreview = document.getElementById('cvPreview');
        
        // Configure html2canvas with enhanced options for better image handling
        const html2canvasOptions = {
            useCORS: true,
            allowTaint: false,
            scale: 2,
            scrollX: 0,
            scrollY: 0,
            width: cvPreview.scrollWidth,
            height: cvPreview.scrollHeight,
            backgroundColor: '#ffffff',
            removeContainer: true,
            imageTimeout: 15000,
            logging: false,
            onclone: function(clonedDoc) {
                // Additional processing on cloned document
                const clonedImages = clonedDoc.querySelectorAll('img');
                clonedImages.forEach(img => {
                    // Ensure images have proper dimensions
                    if (img.getAttribute('data-processed') === 'true') {
                        const width = img.getAttribute('data-original-width');
                        const height = img.getAttribute('data-original-height');
                        if (width && height) {
                            img.style.width = width + 'px';
                            img.style.height = height + 'px';
                        }
                    }
                    
                    // Ensure images are display block to prevent rendering issues
                    img.style.display = 'block';
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                });
            }
        };
        
        // Generate canvas from HTML
        html2canvas(cvPreview, html2canvasOptions).then(canvas => {
            try {
                // Validate canvas
                if (!canvas || canvas.width <= 0 || canvas.height <= 0) {
                    throw new Error('Invalid canvas generated');
                }
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });
                
                // Calculate dimensions
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const canvasAspectRatio = canvas.height / canvas.width;
                const pdfAspectRatio = pdfHeight / pdfWidth;
                
                let imgWidth, imgHeight;
                
                if (canvasAspectRatio > pdfAspectRatio) {
                    // Canvas is taller relative to its width than PDF
                    imgHeight = pdfHeight;
                    imgWidth = imgHeight / canvasAspectRatio;
                } else {
                    // Canvas is wider relative to its height than PDF
                    imgWidth = pdfWidth;
                    imgHeight = imgWidth * canvasAspectRatio;
                }
                
                // Center the image
                const x = (pdfWidth - imgWidth) / 2;
                const y = (pdfHeight - imgHeight) / 2;
                
                // Convert canvas to image data
                const imgData = canvas.toDataURL('image/jpeg', 0.9);
                
                // Validate image data
                if (!imgData || imgData.length === 0) {
                    throw new Error('Failed to generate image data from canvas');
                }
                
                // Add image to PDF
                pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight, undefined, 'FAST');
                
                // Generate filename
                const personalInfo = collectFormData().personalInfo;
                const filename = `CV-${personalInfo.fullName || 'Resume'}.pdf`
                    .replace(/[^a-zA-Z0-9\u0600-\u06FF\s\-_.]/g, '') // Remove invalid characters
                    .replace(/\s+/g, '-'); // Replace spaces with hyphens
                
                // Save PDF
                pdf.save(filename);
                
                console.log('PDF generated successfully');
                showPDFSuccess();
                
            } catch (pdfError) {
                console.error('Error creating PDF:', pdfError);
                handlePDFError('فشل في إنشاء ملف PDF');
            }
            
        }).catch(canvasError => {
            console.error('Error generating canvas:', canvasError);
            handlePDFError('فشل في تحويل المحتوى إلى صورة');
        });
        
    } catch (error) {
        console.error('Error in generatePDFDocument:', error);
        handlePDFError('حدث خطأ في عملية إنشاء PDF');
    }
}

function handlePDFError(message) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'none';
    
    // Show user-friendly error message
    alert(`خطأ في إنشاء PDF: ${message}\n\nتأكد من:\n- جودة الصورة المرفوعة\n- اكتمال تعبئة البيانات\n- استقرار الاتصال بالإنترنت`);
    
    console.error('PDF generation failed:', message);
}

function showPDFSuccess() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
    
    // Show success message
    const successMessage = document.createElement('div');
    successMessage.className = 'success-message';
    successMessage.innerHTML = `
        <div class="success-content">
            <i class="fas fa-check-circle"></i>
            <p>تم إنشاء وتحميل السيرة الذاتية بنجاح!</p>
        </div>
    `;
    
    document.body.appendChild(successMessage);
    
    // Remove success message after 3 seconds
    setTimeout(() => {
        if (successMessage && successMessage.parentNode) {
            successMessage.remove();
        }
    }, 3000);
}
    </script>
</body>
</html>